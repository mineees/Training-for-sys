# Iptables: Как с ним работать

Iptables - это мощный инструмент управления сетью в Linux, который позволяет администраторам управлять входящими и исходящими пакетами данных. Это основной инструмент для настройки межсетевых экранов в системах Linux.

## Введение в Iptables

Iptables работает путем проверки пакетов данных на соответствие определенным критериям и выполнения заданных действий, если пакеты соответствуют этим критериям. Эти критерии и действия определяются в таблицах, которые состоят из набора правил.

В Iptables есть четыре основные таблицы:

- **Filter** - это основная таблица, используемая для фильтрации пакетов.
- **NAT** - эта таблица используется для настройки NAT (Network Address Translation).
- **Mangle** - эта таблица используется для специальной обработки пакетов.
- **Raw** - эта таблица используется для обхода системы отслеживания состояний.

Каждая таблица состоит из набора цепочек. Цепочки - это последовательности правил, которые применяются к пакетам. В Iptables есть три встроенные цепочки:

- **INPUT** - применяется к пакетам, предназначенным для самой системы.
- **FORWARD** - применяется к пакетам, проходящим через систему.
- **OUTPUT** - применяется к пакетам, исходящим из системы.

## Базовые команды Iptables

### Просмотр текущих правил

Чтобы просмотреть текущие правила, используйте команду:

```bash
iptables -L
```

Чтобы просмотреть правила в другой таблице:

```bash
iptables -t nat -L
```

### Добавление новых правил

Чтобы заблокировать весь входящий трафик от IP-адреса `192.168.0.100`:

```bash
iptables -A INPUT -s 192.168.0.100 -j DROP
```

### Удаление правил

Узнайте номера правил:

```bash
iptables -L --line-numbers
```

Удалите правило по номеру:

```bash
iptables -D INPUT 1
```

### Изменение дефолтной политики

Отклонить все входящие пакеты по умолчанию:

```bash
iptables -P INPUT DROP
```

### Сохранение и восстановление правил

Сохранение текущих правил:

```bash
iptables-save > /path/to/iptables/rules
```

Восстановление правил:

```bash
iptables-restore < /path/to/iptables/rules
```

## Примеры использования Iptables

### Блокировка IP-адреса

```bash
iptables -A INPUT -s 192.168.0.100 -j DROP
```

### Открытие порта для входящего трафика

```bash
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
```

### Настройка простого межсетевого экрана

```bash
iptables -A OUTPUT -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT
iptables -P INPUT DROP
```

## Редирект трафика

```bash
iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080
```

## Заключение

Iptables - это мощный и гибкий инструмент, который может быть использован для решения множества задач управления сетью. Однако, как и любой мощный инструмент, он требует тщательного понимания и практики для эффективного использования.

